package fapi

import fapi.Round.bonusMap

import scala.util.Random

object Round {
  val bonusMap: Map[Int, (Int, Map[String, Double])] = Map(
    0 -> (1, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    /*1 -> (2, Map("dmg" -> 0.34, "xp" -> 0.52, "gp" -> 1.12)),
    2 -> (4, Map("dmg" -> 0.05, "xp" -> 0.72, "gp" -> 1.19)),
    3 -> (6, Map("dmg" -> 0.31, "xp" -> 0.35, "gp" -> 1.14)),
    4 -> (8, Map("dmg" -> 0.225, "xp" -> 0.75, "gp" -> 1.03)),
    5 -> (10, Map("dmg" -> 0.19, "xp" -> 0.34, "gp" -> 0.99)),
    6 -> (11, Map("dmg" -> 0.515, "xp" -> 0.46, "gp" -> 1.12)),
    7 -> (13, Map("dmg" -> 0.565, "xp" -> 0.195, "gp" -> 0.2525)),
    8 -> (15, Map("dmg" -> 0.265, "xp" -> 0.30, "gp" -> 0.755)),
    9 -> (16, Map("dmg" -> 0.13, "xp" -> 0.21, "gp" -> 0.59)),
    10 -> (17, Map("dmg" -> 0.2, "xp" -> 0.0, "gp" -> 0.2)),
    11 -> (18, Map("dmg" -> 0.05, "xp" -> 0.7, "gp" -> 1.09)),
    12 -> (19, Map("dmg" -> 0.05, "xp" -> 0.15, "gp" -> 0.61)),
    13 -> (20, Map("dmg" -> 0.015, "xp" -> 0.05, "gp" -> 0.1)),
    14 -> (21, Map("dmg" -> 0.675, "xp" -> 0.16, "gp" -> 0.575)),
    15 -> (22, Map("dmg" -> 0.1575, "xp" -> 0.05, "gp" -> 0.21)),
    16 -> (23, Map("dmg" -> 0.05, "xp" -> 0.01, "gp" -> 0.23)),
    17 -> (24, Map("dmg" -> 0.2, "xp" -> 0.575, "gp" -> 1.22)),
    18 -> (25, Map("dmg" -> 0.05, "xp" -> 0.45, "gp" -> 1.06)),
    19 -> (26, Map("dmg" -> 0, "xp" -> 0.15, "gp" -> 0.22)),
    20 -> (27, Map("dmg" -> 0.065, "xp" -> 0.05, "gp" -> 0.335)),
    21 -> (28, Map("dmg" -> 0.065, "xp" -> 0.315, "gp" -> 0.81)),
    22 -> (29, Map("dmg" -> 0.015, "xp" -> 0, "gp" -> 0.13)),
    23 -> (28, Map("dmg" -> 0.1, "xp" -> 0.1, "gp" -> 0.785)),
    24 -> (29, Map("dmg" -> 0.65, "xp" -> 0.01, "gp" -> 0.325)),
    25 -> (30, Map("dmg" -> 0.1, "xp" -> 0.01, "gp" -> 0.1)),
    26 -> (31, Map("dmg" -> 0.065, "xp" -> 0.02, "gp" -> 0.75)),
    27 -> (32, Map("dmg" -> 0.2, "xp" -> 0.15, "gp" -> 0.37)),
    28 -> (33, Map("dmg" -> 0.06, "xp" -> 0.23, "gp" -> 0.5125)),
    29 -> (32, Map("dmg" -> 0.1, "xp" -> 0.08, "gp" -> 0.5)),
    30 -> (33, Map("dmg" -> 0, "xp" -> 0.15, "gp" -> 0.08)),
    31 -> (32, Map("dmg" -> 0.05, "xp" -> 0.15, "gp" -> 0.51)),
    32 -> (33, Map("dmg" -> 0, "xp" -> 0.05, "gp" -> 0.1)),
    33 -> (34, Map("dmg" -> 0.115, "xp" -> 0.16, "gp" -> 1.31)),
    34 -> (35, Map("dmg" -> 0.05, "xp" -> 0.05, "gp" -> 0.515)),
    35 -> (34, Map("dmg" -> 0.05, "xp" -> 0.1, "gp" -> 0.2725)),
    36 -> (35, Map("dmg" -> 0.2, "xp" -> 0.07, "gp" -> 0.26)),
    37 -> (36, Map("dmg" -> 0.065, "xp" -> 0.125, "gp" -> 0.17)),
    38 -> (37, Map("dmg" -> 0.01, "xp" -> 0.1, "gp" -> 0.79)),
    39 -> (36, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0.25)),
    40 -> (37, Map("dmg" -> 0, "xp" -> 0.06, "gp" -> 0.46)),
    41 -> (36, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0.98)),
    42 -> (37, Map("dmg" -> 0.12, "xp" -> 0.06, "gp" -> 0.945)),
    43 -> (38, Map("dmg" -> 0, "xp" -> 0.01, "gp" -> 0.67)),
    44 -> (37, Map("dmg" -> 0, "xp" -> 0.16, "gp" -> 0.16)),
    45 -> (38, Map("dmg" -> 0.05, "xp" -> 0, "gp" -> 0.115)),
    46 -> (39, Map("dmg" -> 0.015, "xp" -> 0, "gp" -> 0.015)),
    47 -> (38, Map("dmg" -> 0, "xp" -> 0.05, "gp" -> 0.55)),
    48 -> (37, Map("dmg" -> 0.03, "xp" -> 0.2, "gp" -> 0.1)),
    49 -> (38, Map("dmg" -> 0.15, "xp" -> 0, "gp" -> 0.25)),
    50 -> (39, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0.19)),
    51 -> (38, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0.2)),
    52 -> (39, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    53 -> (40, Map("dmg" -> 0.05, "xp" -> 0.22, "gp" -> 0.06)),
    54 -> (39, Map("dmg" -> 0, "xp" -> 0.065, "gp" -> 0.195)),
    55 -> (40, Map("dmg" -> 0.01, "xp" -> 0.15, "gp" -> 0.405)),
    56 -> (39, Map("dmg" -> 0, "xp" -> 0.015, "gp" -> 0.32)),
    57 -> (40, Map("dmg" -> 0, "xp" -> 0.05, "gp" -> 0.445)),
    58 -> (39, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0.035)),
    59 -> (40, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0.325)),
    60 -> (41, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0.045)),
    61 -> (40, Map("dmg" -> 0, "xp" -> 0.15, "gp" -> 0.22)),
    62 -> (41, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0.1)),
    63 -> (40, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0.01)),
    64 -> (41, Map("dmg" -> 0.05, "xp" -> 0.2, "gp" -> 0.255)),
    65 -> (42, Map("dmg" -> 0.15, "xp" -> 0.4, "gp" -> 0.224)),
    66 -> (43, Map("dmg" -> 0.05, "xp" -> 0.12, "gp" -> 0.1)),
    67 -> (42, Map("dmg" -> 0, "xp" -> 0.08, "gp" -> 0)),
    68 -> (43, Map("dmg" -> 0.275, "xp" -> 0.05, "gp" -> 0.25)),
    69 -> (44, Map("dmg" -> 0.2, "xp" -> 0.15, "gp" -> 0.3)),
    70 -> (45, Map("dmg" -> 0.05, "xp" -> 0.05, "gp" -> 0.6)),
    71 -> (44, Map("dmg" -> 0.015, "xp" -> 0, "gp" -> 0)),
    72 -> (43, Map("dmg" -> 0, "xp" -> 0.1, "gp" -> 0.05)),
    73 -> (42, Map("dmg" -> 0, "xp" -> 0.2, "gp" -> 0.1)),

    74 -> (43, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0.1)),

    75 -> (44, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    76 -> (43, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    77 -> (44, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    78 -> (43, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    79 -> (44, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    80 -> (43, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    81 -> (44, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    82 -> (45, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    83 -> (44, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    84 -> (45, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    85 -> (44, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    86 -> (45, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    87 -> (44, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    88 -> (45, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    89 -> (44, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    90 -> (45, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    91 -> (46, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    92 -> (45, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    93 -> (46, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    94 -> (45, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    95 -> (46, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    96 -> (45, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    97 -> (46, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    98 -> (45, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),
    99 -> (46, Map("dmg" -> 0, "xp" -> 0, "gp" -> 0)),*/

    /*3 -> (6, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    4 -> (8, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    5 -> (9, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    6 -> (10, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    7 -> (11, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    8 -> (12, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    9 -> (13, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    10 -> (14, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    11 -> (15, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    12 -> (16, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    13 -> (17, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    14 -> (18, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    15 -> (19, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    16 -> (20, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    17 -> (21, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    18 -> (22, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    19 -> (23, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    20 -> (24, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    21 -> (25, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    22 -> (26, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    23 -> (27, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    24 -> (28, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    25 -> (27, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    26 -> (28, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    27 -> (29, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    28 -> (30, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    29 -> (29, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    30 -> (30, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    31 -> (31, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    32 -> (30, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    33 -> (31, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    34 -> (32, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    35 -> (33, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    36 -> (32, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    37 -> (33, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    38 -> (34, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    39 -> (33, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    40 -> (34, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    41 -> (35, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    42 -> (34, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    43 -> (35, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    44 -> (34, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    45 -> (35, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    46 -> (36, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    47 -> (35, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    48 -> (36, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    49 -> (37, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    50 -> (36, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    51 -> (37, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    52 -> (38, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    53 -> (37, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    54 -> (38, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    55 -> (37, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    56 -> (38, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    57 -> (39, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    58 -> (38, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    59 -> (39, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    60 -> (38, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    61 -> (39, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    62 -> (40, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    63 -> (39, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    64 -> (40, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    65 -> (39, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    66 -> (40, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    67 -> (41, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    68 -> (40, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    69 -> (41, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    70 -> (40, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    71 -> (41, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    72 -> (42, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    73 -> (41, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    74 -> (42, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    75 -> (41, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    76 -> (42, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    77 -> (41, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    78 -> (42, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    79 -> (43, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    80 -> (42, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    81 -> (43, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    82 -> (42, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    83 -> (43, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    84 -> (42, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    85 -> (43, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    86 -> (44, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    87 -> (43, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    88 -> (44, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    89 -> (43, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    90 -> (44, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    91 -> (43, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    92 -> (44, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    93 -> (45, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    94 -> (44, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    95 -> (45, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    96 -> (44, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    97 -> (45, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    98 -> (44, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0)),
    99 -> (45, Map("dmg" -> 0.0, "xp" -> 0.0, "gp" -> 0.0))*/
  )
}

@SerialVersionUID(1L)
class Round(val num: Int, val tier: Int, val boosts: Map[String, Double]) extends Serializable {
  lazy val bossHp: Int = math.ceil(1000000 * math.pow(1.1, tier-1)).toInt
  def attack(level: Int, dmgUpgrade: DmgUpgrade, consUpgrade: ConsUpgrade, hits: Int): Int = {
    (0 until hits).foldLeft(0)((sum, hit) => {
      sum + math.ceil(math.ceil((20.0+level+(2*dmgUpgrade.level)+(hit*(consUpgrade.level+1)))*(1+boosts("dmg")))*(1+0.01*level)).toInt
    })
  }
  def next(dmgDone: Int, ignoreTierMap: Boolean = false, ignoreBoostMap: Boolean = false): Round = new Round(num+1, nextTier(dmgDone, ignoreTierMap), nextBoost(ignoreBoostMap))
  private def nextTier(dmgDone: Int, ignoreTierMap: Boolean = false): Int = {
    if (ignoreTierMap) {
      calcTier(dmgDone)
    } else {
      bonusMap.get(num) match {
        case Some((t, _)) => t
        case None => calcTier(dmgDone)
      }
    }
  }

  private def calcTier(dmgDone: Int): Int = {
    val coeff = dmgDone.toDouble / bossHp
    if (coeff < 0.5) {
      tier - 2
    } else if (coeff <= 1) {
      tier - 1
    } else {
      tier + math.ceil(coeff).toInt - 1
    }
  }

  def nextBoost(ignoreMap: Boolean = false): Map[String, Double] = {
    //lazy val rndBoost = Map("dmg" -> Random.nextInt(35).toDouble / 100.0, "gp" -> Random.nextInt(70).toDouble / 100.0, "xp" -> Random.nextInt(70).toDouble / 100.0)
    lazy val rndBoost = Map("dmg" -> Random.nextInt(15).toDouble / 100.0, "gp" -> Random.nextInt(25).toDouble / 100.0, "xp" -> Random.nextInt(25).toDouble / 100.0)
    if (ignoreMap) {
      rndBoost
    } else {
      bonusMap.getOrElse(num, (0, rndBoost))._2
    }
  }
}
